# Команды в матриксе

Все команды начинаются со знака `!`. Для некоторых команд требуются быть в списке администраторов, который указан конфиге

## invite

`!invite <алиас комнаты>`

Команда требует статуса администратора.

Приглашает пользователя в указанную комнату, в которой присутствует бот.
Если пользователь вводит имя задачи в Jira, то команда регистронезависима, к примеру в таком случае результат будет успешным и пользователь будет приглашен:

```
!invite test-1
Пользователь <id пользователя> приглашен в комнату <имя комнаты>
```

пользователь будет приглашен в комнату `#TEST-1:matrix.yourdomain`.

При вводе точного алиаса вида `#TEST-1:matrix.yourdomain` команда регистрозависима.

Если комната с алиасом не найдена, то будет отправлено сообщение об ошибке с неверным текстом команды:

```
!invite notExistingRoom

Комната "<notExistingRoom>" не найдена
```

Если пользователь не администратор, то будет отправлено сообщение об отсутствие прав:

```
Пользователь "<id пользователя>" не имеет прав администратора для данного действия
```

## op

`!op <id пользователя(опционально)>`

Команда требует статуса администратора.

Дает пользователю права для действий внутри комнаты, такие как: выкидывать других участников из комнаты, банить, удалять чужие сообщения, редактировать параметры комнаты и т.д.

В случае отсутствия аргументов команда распространяется на её автора:

```
!op
Bot changed the power level of @<id пользователя>:matrix.yourdomain from Default (0) to Moderator (50).
```

Если укзать id другого пользователя, то будет изменен его статус:

```
!op other_user
Bot changed the power level of @<other_user>:matrix.yourdomain from Default (0) to Moderator (50).
```

Но для этого обязательно, чтобы пользователь был в комнате, в противном случае будет сообщение об ошибке:

```
!op not_joined_user
Пользователя not_joined_user нет в этой комнате
```

Если пользователь не администратор, то будет отправлено сообщение об отсутствие прав:

```
Пользователь "<id пользователя>" не имеет прав администратора для данного действия
```

## prio

`!prio <номер или имя нового приоритета(опционально)>`

Повышает приоритет текущей задачи в Jira.

В случае отсутствия аргументов команда выведет доступные статусы приоритетов

```
!prio

Список доступных команд:
1) Highest
2) High
3) Medium
4) Low
5) Lowest
```

Если указать номер приоритета или его имя, то приоритет будет изменен с соответствующим статусом (команда регистронезависимая):

```
!prio 1
Теперь задача имеет приоритет Highest
```

```
!prio hIGHeSt
Теперь задача имеет приоритет Highest
```

Если приоритет задачи неверно указан, то будет соответсвующее сообщение:

```
!prio 123
Новый приоритет с именем "123" не найден
```

## move

`!move <номер или имя нового статуса задачи(опционально)>`

Меняет статус текущей задачи в Jira.

В случае отсутствия аргументов команда выведет доступные статусы задачи

```
!move

Список доступных команд:
1) To Do
2) In Progress
3) Done
```

Если указать номер приоритета или его имя, то статус задачи будет изменен с соответствующим статусом (команда регистронезависимая):

```
!move 1
Статус задачи изменён пользователем <id пользователя> на To Do
```

```
!move TO DO
Статус задачи изменён пользователем <id пользователя> на To Do
```

Если приоритет задачи неверно указан, то будет соответсвующее сообщение:

```
!move 123
Новый статус с именем "123" не найден
```

## comment

`!comment <текст сообщения>`

Добавляет комментарий в задаче в Jira, после этого приходит сообщение из Jira:

```
!comment 123
<id бота> добавил(а) комментарий:
<ФИО пользователя>: 123
```

В случае пустого тела сообщения команда ничего не выполнит в Jira и придет предупреждение:

```
!comment
Добавьте текст комментария
```

## spec

`!spec <часть ФИО пользователя/ id пользователя>`

Добавляет наблюдателя в текущую задачу в Jira и приглашает пользователя в комнату матрикс:

```
!spec Иванов Иван

Наблюдатель добавлен
```

```
!spec ia_ivanov

Наблюдатель добавлен
```

Если найдено несколько человек по похожему имени, будет выведен список с соответствующими id:

```
!spec Иванов
Список пользователей:
Иванов Иван Александрович ia_ivanov
Иванова Анна Михайловна am_ivanova
Иванов Петр Петрович pp_ivanov
```

Если никто не найден, то будет отправлено сообщение:

```
!spec Иввввввванов
Наблюдатель не добавлен! Проверьте имя пользователя и попробуйте еще раз
```

В случае, если у бота неверный статус в проекте, то будет следующее уведомление:

```
Иванов Иван Александрович ia_ivanov
Неверно установлен статус бота в проекте <ключ проекта со ссылкой>, обратитесь к администратору
```

В случае, если бот был удален из участников проекта или иная проблема с отсутствием доступа к задаче (в том числе если она удалена), то будет следующее уведомление:

```
!assign Иванов Иван Александрович
У бота нет прав для просмотра и совершения действий в данной задаче в Jira
```

## assign

`!assign <часть ФИО пользователя/ id пользователя>`

Делает пользователя исполнителем в текущей задаче в Jira и приглашает пользователя в комнату матрикс:

```
!assign Иванов Иван

Пользователь "<ФИО пользователя>" назначен исполнителем задачи
```

```
!assign ia_ivanov

Пользователь "<ФИО пользователя>" назначен исполнителем задачи
```

Если найдено несколько человек по похожему имени, будет выведен список с соответствующими id:

```
!assign Иванов
Список пользователей:
Иванов Иван Александрович ia_ivanov
Иванова Анна Михайловна am_ivanova
Иванов Петр Петрович pp_ivanov
```

Если никто не найден, то будет отправлено сообщение:

```
!assign ИвввВВВВВВанов
Наблюдатель ИвввВВВВВВанов не добавлен! Проверьте имя пользователя и попробуйте еще раз
```

В случае, если у бота неверный статус в проекте, то будет следующее уведомление:

```
Иванов Иван Александрович ia_ivanov
Неверно установлен статус бота в проекте <ключ проекта со ссылкой>, обратитесь к администратору
```

В случае, если бот был удален из участников проекта или иная проблема с отсутствием доступа к задаче (в том числе если она удалена), то будет следующее уведомление:

```
!assign Иванов Иван Александрович
У бота нет прав для просмотра и совершения действий в данной задаче в Jira
```

## ignore

`!ignore <add|del> <taskType>`

Команда позволяет настроивать игнорирование типов задач для текущего проекта. Типы задач могут быть разные для разных проектов.

Команда могут использовать только администраторы текущего проекта.
Если пользователь без прав администратора введет команду:

```
!ignore
Пользователь "<user-not-admin>" не имеет прав администратора для данного действия
```

Если параметры уже были добавлены ранее, вы увидите сообщение. Типы задач из этого списка вы можете использовать для удаление настроек игнорирования.

```
!ignore
Текущие настройки игнорирования для проекта "<current project for this room>":
    1) - Task
    2) - Epic
    3) - Bug

```

Если параметры ранее не были добавлены в проект:

```
!ignore
Для проекта TCP настройки пока не сделаны.
Вы можете добавить тип командой !ignore add Error
```

### Добавление:

```
!ignore add Error
Ключ "Error" был добавлен для проекта "<current project for this room>".
or
!ignore add Error
Ключ "Error" уже добавлен в игнор лист для проекта "<current project for this room>".
```

Если тип задачи не был найден в списке возможных для этого проекта (настраивается в Jira):

```
!ignore add wrongTaskType
Такой ключ не предусмотрен в проекте "<current project for this room>".
Вы можете использовать ключи:
    1) - Story
    2) - Epic
    3) - Error
    4) - Task
    5) - test
    6) - Discussion
```

После успешного добавления настройки хуки с этим типом задачи будут игнорироваться для текущего проекта.

### Удаление:

```
!ignore del Error
Ключ "Error" был удален для проекта "<current project for this room>".
or
!ignore del Error
Ключ не найден в настройках проекта "<current project for this room>".
```

### Как это работает

Настройки записываются в Redis с префиксом `ignore:project` и сохраняются в файл.

## create

`!create <тип задачи> Название для новой задачи в Jira`

Создает новую задачу в Jire и добавляет ссылку на текущую задачу:

```
!create Task Моя новая задача

Новая связь, эта задача relates to "New-Jira-key" "Моя новая задача"
```

Варианты без параметров:

```
!create
Типы задач в проекте "TCP":
1) - Task
2) - Epic
3) - Bug
```

```
!create Task
Не найдено название задачи.
Используйте команду !create ТИП_ЗАДАЧИ  название задачи в Jira
```

Алгоритм создания связи новой задачи с текущей:

1. Если текущая задача является эпиком, то создается дочерняя задача к текущему эпику.
2. Если создаваемая задача является подзадачей, то создается дочерняя задача к текущей задаче.
3. В эпике нельзя создавать подзадачи.
4. Если создаваемая задача не подзадача и текущая задача не эпик - между задачами создается связь `relates to`
